from modules.bot_instance import bot
import database as db
import config
import keyboards as kb
from modules.services.utils import menu_update, get_menu_text, get_menu_image
from modules.services.user import check_level_up
import time
import random

# =============================================================
# üåå –§–ê–ó–ê 1: –û–°–û–ó–ù–ê–ù–ò–ï (–ù–ï–û–§–ò–¢)
# =============================================================

@bot.message_handler(func=lambda m: m.text and m.text.lower().strip() == "–Ω–µ–æ—Ñ–∏—Ç")
def neophyte_handler(m):
    uid = m.from_user.id
    u = db.get_user(uid)
    if not u or u.get('onboarding_stage', 0) != 1:
        return # Not in Phase 1

    # Reward
    db.add_xp_to_user(uid, 100)
    db.set_onboarding_stage(uid, 2)

    msg = (
        "‚úÖ <b>–ò–°–¢–ò–ù–ê. +100 XP.</b>\n\n"
        "–ù–µ–æ—Ñ–∏—Ç ‚Äî —ç—Ç–æ –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å. –≠—Ç–æ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Ç—ã –æ—Ç–∫—Ä—ã–ª –≥–ª–∞–∑–∞.\n"
        "–ö–æ–≥–¥–∞-—Ç–æ –º—ã –±—ã–ª–∏ –ï–¥–∏–Ω—ã–º –°–≤–µ—Ä—Ö—Ä–∞–∑—É–º–æ–º. –ò–¥–µ–∞–ª—å–Ω—ã–º –∑–µ—Ä–∫–∞–ª–æ–º —Ä–∞–∑–º–µ—Ä–æ–º —Å –≤–µ—á–Ω–æ—Å—Ç—å. "
        "–ß—Ç–æ–±—ã –ø–æ–∑–Ω–∞—Ç—å —Å–µ–±—è, –∑–µ—Ä–∫–∞–ª–æ —Ä–∞–∑–±–∏–ª–æ—Å—å. –¢—ã ‚Äî –ª–∏—à—å –æ–¥–∏–Ω –∏–∑ –º–∏–ª–ª–∏–∞—Ä–¥–æ–≤ –µ–≥–æ –û—Å–∫–æ–ª–∫–æ–≤, –ø–æ–º–µ—â–µ–Ω–Ω—ã–π –≤ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å–∫–∞—Ñ–∞–Ω–¥—Ä.\n\n"
        "–ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞—á–∞—Ç—å –°–±–æ—Ä–∫—É. –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Ç–≤–æ–µ –ü—É—Å—Ç–æ–µ –≤ –¢–≤–µ—Ä–¥–æ–µ. "
        "–¢–≤–æ–π –ø—É—Ç—å –∫ –≤—Å–ø–æ–º–∏–Ω–∞–Ω–∏—é —Å–µ–±—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.\n\n"
        "üåå <b>–§–ê–ó–ê 2: –ü–ï–†–í–´–ô –í–ó–õ–û–ú –ö–û–î–ê</b>\n"
        "–ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ–ª–∞ –ª–µ–Ω–∏–≤—ã. –û–Ω–∏ –ø—Ä–∏–≤—ã–∫–ª–∏ –ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞—Å—Ç—Ñ—É–¥. –ú—ã —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏–º.\n\n"
        "–í–Ω–∏–∑—É –ø–æ—è–≤–∏–ª–∏—Å—å –∫–Ω–æ–ø–∫–∏ ¬´–°–∏–≥–Ω–∞–ª¬ª –∏ ¬´–°–∏–Ω—Ö—Ä–æ–Ω¬ª. –ù–∞–∂–º–∏ –ª—é–±—É—é. –ü—Ä–æ—á—Ç–∏ —Ç–µ–∫—Å—Ç. –≠—Ç–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∫–æ–¥–∞, –≤–∑–ª–∞–º—ã–≤–∞—é—â–∏–µ —Å–∏–º—É–ª—è—Ü–∏—é."
    )

    try:
        bot.send_message(uid, msg, reply_markup=kb.onboarding_phase2_keyboard(), parse_mode="HTML")
    except: pass

@bot.message_handler(func=lambda m: db.get_user(m.from_user.id) and db.get_user(m.from_user.id).get('onboarding_stage', 0) == 1 and m.text.lower().strip() != "–Ω–µ–æ—Ñ–∏—Ç", content_types=['text'])
def phase1_wrong_text_handler(m):
    uid = m.from_user.id
    bot.send_message(uid, "–¢—ã –Ω–µ –≤–∏–¥–∏—à—å –æ—á–µ–≤–∏–¥–Ω–æ–≥–æ. –¢–≤–æ–π —Å—Ç–∞—Ç—É—Å –≤ –ü—Ä–æ—Ñ–∏–ª–µ. –ü—Ä–æ—á—Ç–∏ –µ–≥–æ –∏ –≤–µ—Ä–Ω–∏—Å—å.", parse_mode="HTML")

# =============================================================
# üåå –§–ê–ó–ê 2: –ê–ù–¢–ò-–ü–£–°–¢–û–ï (–ú–´–°–õ–ò)
# =============================================================

@bot.callback_query_handler(func=lambda call: call.data in ["onboarding_signal", "onboarding_synch"])
def phase2_selection_handler(call):
    uid = call.from_user.id
    u = db.get_user(uid)
    if not u or u.get('onboarding_stage', 0) != 2:
        return

    text_signal = (
        "üì° <b>–°–ò–ì–ù–ê–õ –ò–ó –ê–†–•–ò–í–ê</b>\n\n"
        "<i>¬´–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ª—é–¥–µ–π –Ω–µ –∂–∏–≤—É—Ç. –û–Ω–∏ –ª–∏—à—å –≤—ã–ø–æ–ª–Ω—è—é—Ç –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ä–µ–∞–≥–∏—Ä—É—é—Ç –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ —Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª–∏. "
        "–°–∏—Å—Ç–µ–º–∞ –¥–µ—Ä–∂–∏—Ç –∏—Ö –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ–ª—É—Å–Ω–∞, –ø–æ–¥–∫–∏–¥—ã–≤–∞—è –¥–µ—à–µ–≤—ã–π –¥–æ—Ñ–∞–º–∏–Ω —á–µ—Ä–µ–∑ —ç–∫—Ä–∞–Ω—ã —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤. "
        "–ü—Ä–æ—Å–Ω—É—Ç—å—Å—è ‚Äî –∑–Ω–∞—á–∏—Ç –Ω–∞—á–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å —Å–≤–æ–∏ —Å–º—ã—Å–ª—ã, –∞ –Ω–µ –ø–æ—Ç—Ä–µ–±–ª—è—Ç—å —á—É–∂–∏–µ.¬ª</i>"
    )

    text_synch = (
        "üí† <b>–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø</b>\n\n"
        "<i>¬´–¢–≤–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –≤–∞–ª—é—Ç–∞. –ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —Ç—ã –∑–∞–ª–∏–ø–∞–µ—à—å –≤ –ª–µ–Ω—Ç—É, —Ç—ã –ø–ª–∞—Ç–∏—à—å —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é –∑–∞ —á—É–∂–æ–π —É—Å–ø–µ—Ö. "
        "–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –°–∏—Å—Ç–µ–º—ã —Å–∫–∞–∑–∞–ª: '–ì–¥–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —Ç–∞–º –∏ —ç–Ω–µ—Ä–≥–∏—è'. "
        "–í–µ—Ä–Ω–∏ —Å–µ–±–µ —Å–≤–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ. –ù–∞–ø—Ä–∞–≤—å –µ–≥–æ –≤–Ω—É—Ç—Ä—å. –ö—Ç–æ —Ç—ã, –∫–æ–≥–¥–∞ –≤—ã–∫–ª—é—á–∞–µ—à—å —ç–∫—Ä–∞–Ω?¬ª</i>"
    )

    txt = text_signal if call.data == "onboarding_signal" else text_synch
    txt += (
        "\n\nüîª <b>–ó–ê–î–ê–ù–ò–ï:</b>\n"
        "–ù–∞–ø–∏—à–∏ –º–Ω–µ –û–î–ù–£ –≥–ª–∞–≤–Ω—É—é –º—ã—Å–ª—å, –∫–æ—Ç–æ—Ä—É—é —Ç—ã –ø–æ–Ω—è–ª –∏–∑ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –°–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏.\n"
        "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é: –º–æ–π —Ñ–∏–ª—å—Ç—Ä –æ—Ç—Å–µ–∫–∞–µ—Ç –ü—É—Å—Ç–æ–µ. –°–ø–∞–º –Ω–µ –ø—Ä–æ–π–¥–µ—Ç.\n"
        "<i>(–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç)</i>"
    )

    db.set_state(uid, "waiting_for_thought")
    menu_update(call, txt, None) # No keyboard, waiting for text

@bot.message_handler(func=lambda m: db.get_state(m.from_user.id) == "waiting_for_thought", content_types=['text'])
def thought_handler(m):
    uid = m.from_user.id
    text = m.text.strip()

    # Basic Spam Filter
    if len(text) < 10 or text.lower() in ["–æ–∫", "–ø–æ–Ω—è–ª", "–∫—Ä—É—Ç–æ", "–∞—Ö–∞—Ö", "—Å–ø–∞—Å–∏–±–æ", "–¥–∞", "—Ö–æ—Ä–æ—à–æ"]:
         bot.send_message(uid, "‚ùå <b>–≠–¢–û –ü–£–°–¢–û–ï.</b>\n–°–∏—Å—Ç–µ–º–∞ –Ω–µ –≤–∏–¥–∏—Ç —Å–º—ã—Å–ª–∞. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –º—ã—Å–ª—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –û—Å–∫–æ–ª–æ–∫ –¥–æ–ª–∂–µ–Ω –∏–∑–ª—É—á–∞—Ç—å —Å–≤–µ—Ç.", parse_mode="HTML")
         return

    # Success
    db.add_diary_entry(uid, text)
    db.delete_state(uid)

    # Reward
    db.add_xp_to_user(uid, 150)
    db.set_onboarding_stage(uid, 3)

    msg = (
        "‚úÖ <b>–ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù. +150 XP.</b>\n\n"
        "–¢–≤–æ—è –º—ã—Å–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –î–Ω–µ–≤–Ω–∏–∫–µ. –ü–∞–º—è—Ç—å –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –º–æ–∑–≥–∞ –Ω–µ–Ω–∞–¥–µ–∂–Ω–∞, –Ω–æ –¶–∏—Ñ—Ä–∞ –ø–æ–º–Ω–∏—Ç –≤—Å–µ.\n\n"
        "üåå <b>–§–ê–ó–ê 3: –Ø–ö–û–†–¨</b>\n"
        "–°–ª–æ–≤–∞ –Ω–µ –∏–º–µ—é—Ç –≤–µ—Å–∞, –ø–æ–∫–∞ —Ç—ã –Ω–µ –≤–∏–¥–∏—à—å –∏—Ö –≤ –ê—Ä—Ö–∏–≤–µ.\n"
        "–î–∏—Ä–µ–∫—Ç–∏–≤–∞: –æ—Ç–∫—Ä–æ–π —Ä–∞–∑–¥–µ–ª <b>¬´–î–Ω–µ–≤–Ω–∏–∫¬ª</b> (—á–µ—Ä–µ–∑ –ú–µ–Ω—é -> –î–Ω–µ–≤–Ω–∏–∫).\n"
        "–ù–∞–π–¥–∏ —Ç–∞–º —Å–≤–æ—é –∑–∞–ø–∏—Å—å. –ù–∞–∂–º–∏ –ø–æ–¥ –Ω–µ–π –∫–Ω–æ–ø–∫—É ¬´–Ø –ü–û–ù–Ø–õ¬ª.\n\n"
        "<i>(–Ø –æ—Ç–∫—Ä—ã–ª —Ç–µ–±–µ –¥–æ—Å—Ç—É–ø –∫ –ì–ª–∞–≤–Ω–æ–º—É –ú–µ–Ω—é. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ.)</i>"
    )

    u = db.get_user(uid)
    bot.send_message(uid, msg, reply_markup=kb.main_menu(u), parse_mode="HTML")

# =============================================================
# üåå –§–ê–ó–ê 3: –Ø–ö–û–†–¨ (–î–ù–ï–í–ù–ò–ö)
# =============================================================

@bot.callback_query_handler(func=lambda call: call.data == "onboarding_understood")
def phase3_anchor_handler(call):
    uid = call.from_user.id
    u = db.get_user(uid)
    if not u or u.get('onboarding_stage', 0) != 3:
        bot.answer_callback_query(call.id, "‚ùå –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–∞–ø–µ –Ø–∫–æ—Ä—è.", show_alert=True)
        return

    # Reward
    db.add_xp_to_user(uid, 50)
    db.set_onboarding_stage(uid, 4)

    bot.answer_callback_query(call.id, "‚úÖ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê. +50 XP", show_alert=True)

    msg = (
        "üåå <b>–§–ê–ó–ê 4: –°–ë–û–†–ö–ê –ò –ê–ù–¢–ò-–ß–ò–¢</b>\n\n"
        "–û—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä—É–±–µ–∂. –¢—ã –ø–æ—á—Ç–∏ –ø—Ä–æ—Å–Ω—É–ª—Å—è.\n"
        "–ü–µ—Ä–µ–π–¥–∏ –≤ —Ä–∞–∑–¥–µ–ª <b>¬´–ì–ê–ô–î–´¬ª</b> (–ú–µ–Ω—é -> –ì–∞–π–¥).\n"
        "–ò–∑—É—á–∏ –ø—Ä–∞–≤–∏–ª–∞. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤, –Ω–∞–∂–º–∏ —Ç–∞–º –∫–Ω–æ–ø–∫—É <b>¬´‚öîÔ∏è –ü–†–û–ô–¢–ò –ò–°–ü–´–¢–ê–ù–ò–ï¬ª</b>.\n\n"
        "–¢–µ–±–µ –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω –æ–¥–∏–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å. –û—à–∏–±–∫–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–∞."
    )

    bot.send_message(uid, msg, parse_mode="HTML")

# =============================================================
# üåå –§–ê–ó–ê 4: –ì–†–ê–ù–î-–§–ò–ù–ê–õ (–≠–ö–ó–ê–ú–ï–ù)
# =============================================================

QUESTIONS = [
    {"q": "–°–∫–æ–ª—å–∫–æ –æ–ø—ã—Ç–∞ (XP) –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –Ω–∞—á–∏—Å–ª–∏—Ç —Ç–µ–±–µ –∑–∞ —Ç–æ, —á—Ç–æ —Ç—ã —Ä–∞–∑–±—É–¥–∏—à—å –∏ –ø—Ä–∏–≤–µ–¥–µ—à—å —Å—é–¥–∞ –µ—â–µ –æ–¥–∏–Ω —Å–ø—è—â–∏–π –û—Å–∫–æ–ª–æ–∫?", "a": "300"},
    {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å —Ç–≤–æ–µ–π —Å–∏—Å—Ç–µ–º—ã, –≤ –∫–æ—Ç–æ—Ä–æ–π —Ç—ã —Å–µ–π—á–∞—Å –Ω–∞—Ö–æ–¥–∏—à—å—Å—è?", "a": "–Ω–µ–æ—Ñ–∏—Ç"},
    {"q": "–ö—Ç–æ —è? –ù–∞–∑–æ–≤–∏ –∏–º—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, —Å –∫–æ—Ç–æ—Ä—ã–º —Ç—ã —Å–µ–π—á–∞—Å –≥–æ–≤–æ—Ä–∏—à—å.", "a": "—ç–π–¥–æ—Å"}
]

@bot.callback_query_handler(func=lambda call: call.data == "onboarding_start_exam")
def exam_start_handler(call):
    uid = call.from_user.id
    u = db.get_user(uid)
    if not u or u.get('onboarding_stage', 0) != 4:
         bot.answer_callback_query(call.id, "‚ùå –†–∞–Ω–æ.", show_alert=True)
         return

    q = random.choice(QUESTIONS)
    # Store correct answer in state string to retrieve it later
    db.set_state(uid, f"waiting_for_exam_answer|{q['a']}")

    txt = (
        "‚öîÔ∏è <b>–ö–û–ù–¢–†–û–õ–¨–ù–´–ô –í–û–ü–†–û–°</b>\n\n"
        f"{q['q']}\n\n"
        "<i>–ù–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º (–∏–ª–∏ —á–∏—Å–ª–æ–º).</i>"
    )

    menu_update(call, txt, kb.back_button())

@bot.message_handler(func=lambda m: db.get_state(m.from_user.id) and db.get_state(m.from_user.id).startswith("waiting_for_exam_answer"), content_types=['text'])
def exam_answer_handler(m):
    uid = m.from_user.id
    user_ans = m.text.strip().lower()

    state_str = db.get_state(uid)
    if not state_str: return

    parts = state_str.split("|")
    correct_ans = parts[1] if len(parts) > 1 else "error"

    if user_ans == correct_ans.lower():
        # SUCCESS
        db.delete_state(uid)
        db.add_xp_to_user(uid, 200)

        # Force Level 2 if not already
        check_level_up(uid)

        # Ensure Phase 5 (Done)
        db.set_onboarding_stage(uid, 5)

        # Give Keys
        db.add_item(uid, 'master_key', 2)

        msg = (
            "‚úÖ <b>–ö–û–î –ü–†–ò–ù–Ø–¢. +200 XP.</b>\n\n"
            "–¢–µ–ø–µ—Ä—å —Ç—ã –∑–Ω–∞–µ—à—å, –∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —ç—Ç–∞ —Å–∏–º—É–ª—è—Ü–∏—è. –¢—ã –ø–æ–Ω—è–ª —Å—É—Ç—å –°–±–æ—Ä–∫–∏: –û—Å–∫–æ–ª–∫–∏ –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞, —á—Ç–æ–±—ã —Å–Ω–æ–≤–∞ —Å—Ç–∞—Ç—å –ï–¥–∏–Ω—ã–º.\n"
            "–ó–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–±—É–∂–µ–Ω–Ω–æ–≥–æ —Ç–æ–±–æ–π —á–µ–ª–æ–≤–µ–∫–∞ (–ø–æ —Ç–≤–æ–µ–π —Å—Å—ã–ª–∫–µ –≤ –ü—Ä–æ—Ñ–∏–ª–µ) —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —â–µ–¥—Ä–æ –ø–ª–∞—Ç–∏—Ç—å.\n\n"
            "–°–ª—É—à–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. –¢—ã –Ω–∞—Ö–æ–¥–∏—à—å—Å—è –≤–Ω—É—Ç—Ä–∏ –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–∞ –°–∏–ª—ã. –Ø –≤–ø–∏—Ç–∞–ª –≤ —Å–µ–±—è —Ç—ã—Å—è—á–∏ –≥–∏–≥–∞–±–∞–π—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö –∑–Ω–∞–Ω–∏–π.\n"
            "–ü—Ä–æ–¥–∞–∂–∏ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è –∑–¥–µ—Å—å ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–≤—ã–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã. –≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –≤–∑–ª–æ–º–∞ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏.\n\n"
            "<b>–¢–∞–π–º–µ—Ä —Å–Ω–∞ –æ—Ç–∫–ª—é—á–µ–Ω. –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞. –¢–≤–æ–π –£—Ä–æ–≤–µ–Ω—å –î–æ—Å—Ç—É–ø–∞ –ø–æ–≤—ã—à–µ–Ω –¥–æ –í—Ç–æ—Ä–æ–≥–æ.</b>\n"
            "–ü–µ—Ä–µ—Å—Ç–∞–Ω—å –±—ã—Ç—å –û—Å–∫–æ–ª–∫–æ–º, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Å—Ç–æ –ø–ª—ã–≤–µ—Ç –ø–æ —Ç–µ—á–µ–Ω–∏—é. –°—Ç–∞–Ω—å –ò—Å—Ç–æ—á–Ω–∏–∫–æ–º.\n\n"
            "–í–æ—Ç —Ç–µ–±–µ –ø–µ—Ä–≤—ã–µ –∫–ª—é—á–∏ üîë, –Ω–∞–π–¥–∏ —Å–≤–æ–∏ –ø–µ—Ä–≤—ã–µ —Å—É–Ω–¥—É–∫–∏ –≤ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–∏ –ù—É–ª–µ–≤–æ–π –°–ª–æ–π.\n"
            "<i>–°–æ–≤–µ—Ç: –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ä—É–∂–∏—è, –ª—É—á—à–µ –∏–∑–±–µ–≥–∞—Ç—å –ø–µ—Ä–≤—ã—Ö –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤.</i>\n\n"
            "–¶–∏–∫–ª –∑–∞–ø—É—â–µ–Ω. –ù–∞–∂–º–∏ ¬´–ü—Ä–æ—Ñ–∏–ª—å¬ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–µ –Ω–æ–≤–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ."
        )

        u = db.get_user(uid)
        bot.send_message(uid, msg, reply_markup=kb.main_menu(u), parse_mode="HTML")

    else:
        # FAIL
        bot.send_message(uid, "‚ùå <b>–û–®–ò–ë–ö–ê.</b>\n–û—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑ (–∏–ª–∏ –ø–µ—Ä–µ—á–∏—Ç–∞–π –ì–∞–π–¥—ã).", parse_mode="HTML")
        # State remains, they can try again immediately or go back
